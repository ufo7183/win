<?php
/*
 * Plugin Name: Newtide 帝公 自訂客製化功能插件
 * Plugin URI: https://www.newtide.com.tw/
 * Description: 整合前端購物車欄位與後台訂單顯示功能的完整版插件（含日誌檢視器）。
 * Version: 14.0 - Multi-Hook Storage
 * Author: CGLandmark Studio
 */

if ( ! defined( 'ABSPATH' ) ) {
    exit;
}

add_action( 'plugins_loaded', 'newtide_final_plugin_init_v13' );

function newtide_final_plugin_init_v13() {
    if ( ! class_exists( 'WooCommerce' ) ) {
        return;
    }

    define('NEWTIDE_META_KEY_V13', '_estimate_purchasing_schedule');
    define('NEWTIDE_LABEL_V13', 'Estimate Purchasing Schedule');
    define('NEWTIDE_DEBUG_V13', true); // 開啟調試模式
    define('NEWTIDE_LOG_OPTION_V13', 'newtide_debug_logs_v13'); // 日誌儲存選項名稱

    // 調試日誌函數 - 儲存到資料庫
    if (!function_exists('newtide_debug_log_v13')) {
        function newtide_debug_log_v13($message, $data = null) {
            if (NEWTIDE_DEBUG_V13) {
                $logs = get_option(NEWTIDE_LOG_OPTION_V13, array());
                
                // 限制日誌數量，避免資料庫過大（保留最新 500 筆）
                if (count($logs) > 500) {
                    $logs = array_slice($logs, -450);
                }
                
                $log_entry = array(
                    'time' => current_time('mysql'),
                    'message' => $message,
                    'data' => $data
                );
                
                $logs[] = $log_entry;
                update_option(NEWTIDE_LOG_OPTION_V13, $logs);
                
                // 同時寫入錯誤日誌（如果有權限的話）
                $log_message = '[' . date('Y-m-d H:i:s.v') . '] - v13 ' . $message;
                if ($data !== null) {
                    $log_message .= ' | Data: ' . print_r($data, true);
                }
                error_log($log_message);
            }
        }
    }

    newtide_debug_log_v13('插件初始化成功 (Plugin Initialized)');

    // --- 新增管理員選單 ---
    add_action('admin_menu', 'newtide_add_admin_menu_v13');

    // --- 前端 ---
    add_action('woocommerce_after_cart_item_name', 'newtide_add_schedule_field_to_cart_v13', 10, 2);
    add_filter('woocommerce_get_cart_item_from_session', 'newtide_get_schedule_from_session_v13', 20, 2);
    add_action('wp_footer', 'newtide_add_custom_ajax_script_v13');

    // --- AJAX Endpoints ---
    add_action('wp_ajax_newtide_update_schedule_v13', 'newtide_ajax_update_schedule_handler_v13');
    add_action('wp_ajax_nopriv_newtide_update_schedule_v13', 'newtide_ajax_update_schedule_handler_v13');
    add_action('wp_ajax_newtide_clear_logs_v13', 'newtide_ajax_clear_logs_v13');
    add_action('wp_ajax_newtide_run_diagnostic_v13', 'newtide_ajax_run_diagnostic_v13');

    // --- 儲存邏輯 - 使用多個 hooks 確保資料儲存 ---
    add_action( 'woocommerce_checkout_create_order_line_item', 'newtide_add_custom_data_to_order_item_v13', 10, 4 );
    add_action( 'woocommerce_new_order_item', 'newtide_save_order_item_meta_v13', 10, 3 );
    add_action( 'woocommerce_add_order_item_meta', 'newtide_legacy_save_order_item_meta_v13', 10, 3 );
    add_filter( 'woocommerce_hidden_order_itemmeta', 'newtide_hide_order_item_meta_v13' );

    // --- 後台與前端顯示 ---
    add_action('woocommerce_before_order_itemmeta', 'newtide_display_admin_order_item_field_v13', 10, 2);
    add_action('woocommerce_saved_order_items', 'newtide_save_admin_order_item_field_v13', 10, 2);
    add_action('woocommerce_order_item_meta_end', 'newtide_display_schedule_in_order_details_v13', 10, 4);
    
    // --- 額外的調試顯示 ---
    add_action('woocommerce_after_order_itemmeta', 'newtide_debug_display_all_meta_v13', 10, 2);
}

// --- 新增管理員選單 ---
function newtide_add_admin_menu_v13() {
    add_menu_page(
        'Newtide 調試日誌',
        'Newtide 日誌',
        'manage_options',
        'newtide-debug-logs',
        'newtide_debug_logs_page_v13',
        'dashicons-clipboard',
        58
    );
}

// --- 日誌頁面內容 ---
function newtide_debug_logs_page_v13() {
    ?>
    <div class="wrap">
        <h1>Newtide 調試日誌</h1>
        
        <div style="margin: 20px 0;">
            <button id="newtide-clear-logs" class="button button-secondary">清除所有日誌</button>
            <button id="newtide-refresh-logs" class="button button-primary">重新整理</button>
            <button id="newtide-run-diagnostic" class="button button-secondary">執行診斷</button>
            <span id="newtide-log-status" style="margin-left: 20px;"></span>
        </div>
        
        <div id="newtide-diagnostic-result" style="display: none; margin: 20px 0; padding: 15px; background: #fff; border: 1px solid #ccc;">
            <h3>診斷結果</h3>
            <div id="diagnostic-content"></div>
        </div>
        
        <?php
        $logs = get_option(NEWTIDE_LOG_OPTION_V13, array());
        $logs = array_reverse($logs); // 最新的在上面
        
        if (empty($logs)) {
            echo '<p>目前沒有日誌資料。</p>';
        } else {
            ?>
            <div style="background: #f9f9f9; border: 1px solid #ddd; padding: 10px; max-height: 600px; overflow-y: auto;">
                <table class="widefat" style="background: white;">
                    <thead>
                        <tr>
                            <th style="width: 180px;">時間</th>
                            <th>訊息</th>
                            <th>資料</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($logs as $index => $log): ?>
                            <tr class="<?php echo $index % 2 ? 'alternate' : ''; ?>">
                                <td style="font-family: monospace; font-size: 12px;">
                                    <?php echo esc_html($log['time']); ?>
                                </td>
                                <td>
                                    <?php echo esc_html($log['message']); ?>
                                </td>
                                <td>
                                    <?php 
                                    if ($log['data'] !== null) {
                                        echo '<pre style="margin: 0; font-size: 11px; max-width: 500px; overflow-x: auto;">';
                                        echo esc_html(print_r($log['data'], true));
                                        echo '</pre>';
                                    } else {
                                        echo '-';
                                    }
                                    ?>
                                </td>
                            </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>
            <p style="margin-top: 10px; color: #666;">
                顯示 <?php echo count($logs); ?> 筆日誌（最多保留 500 筆）
            </p>
            <?php
        }
        ?>
        
        <script type="text/javascript">
        jQuery(function($) {
            $('#newtide-clear-logs').on('click', function() {
                if (confirm('確定要清除所有日誌嗎？')) {
                    $.ajax({
                        url: ajaxurl,
                        type: 'POST',
                        data: {
                            action: 'newtide_clear_logs_v13',
                            security: '<?php echo wp_create_nonce('newtide-clear-logs-nonce'); ?>'
                        },
                        success: function(response) {
                            if (response.success) {
                                $('#newtide-log-status').html('<span style="color: green;">日誌已清除！</span>');
                                setTimeout(function() {
                                    location.reload();
                                }, 1000);
                            }
                        }
                    });
                }
            });
            
            $('#newtide-refresh-logs').on('click', function() {
                location.reload();
            });
            
            $('#newtide-run-diagnostic').on('click', function() {
                $('#diagnostic-content').html('執行診斷中...');
                $('#newtide-diagnostic-result').show();
                
                $.ajax({
                    url: ajaxurl,
                    type: 'POST',
                    data: {
                        action: 'newtide_run_diagnostic_v13',
                        security: '<?php echo wp_create_nonce('newtide-diagnostic-nonce'); ?>'
                    },
                    success: function(response) {
                        if (response.success) {
                            $('#diagnostic-content').html(response.data);
                        } else {
                            $('#diagnostic-content').html('<p style="color: red;">診斷失敗</p>');
                        }
                    }
                });
            });
        });
        </script>
    </div>
    <?php
}

// --- AJAX 清除日誌 ---
function newtide_ajax_clear_logs_v13() {
    check_ajax_referer('newtide-clear-logs-nonce', 'security');
    
    if (current_user_can('manage_options')) {
        delete_option(NEWTIDE_LOG_OPTION_V13);
        newtide_debug_log_v13('日誌已被清除');
        wp_send_json_success('Logs cleared');
    } else {
        wp_send_json_error('Permission denied');
    }
}

// --- 前端 AJAX 相關函式 ---
function newtide_add_schedule_field_to_cart_v13($cart_item, $cart_item_key) {
    $value = isset($cart_item[NEWTIDE_META_KEY_V13]) ? $cart_item[NEWTIDE_META_KEY_V13] : '';
    newtide_debug_log_v13('顯示購物車欄位', array('cart_item_key' => $cart_item_key, 'current_value' => $value));
    
    echo '<div class="estimate-purchase-schedule" style="margin-top: 5px;">';
    echo '<select data-item-key="' . esc_attr($cart_item_key) . '" class="estimate-purchase-select-field" style="width: 12em;">';
    echo '<option value="">' . esc_html(NEWTIDE_LABEL_V13) . '</option>';
    echo '<optgroup label="Short Term">';
    echo '<option value="< 1 month"' . selected($value, '< 1 month', false) . '>< 1 month</option>';
    echo '<option value="1-3 months"' . selected($value, '1-3 months', false) . '>1-3 months</option>';
    echo '</optgroup>';
    echo '<optgroup label="Mid Term">';
    echo '<option value="3-6 months"' . selected($value, '3-6 months', false) . '>3-6 months</option>';
    echo '<option value="6-12 months"' . selected($value, '6-12 months', false) . '>6-12 months</option>';
    echo '</optgroup>';
    echo '<optgroup label="Long Term">';
    echo '<option value="> 1 year"' . selected($value, '> 1 year', false) . '>> 1 year</option>';
    echo '</optgroup>';
    echo '</select>';
    echo '</div>';
}

function newtide_add_custom_ajax_script_v13() {
    if (!is_cart()) return;
    $nonce = wp_create_nonce('newtide-schedule-nonce-v13');
    ?>
    <script type="text/javascript">
    jQuery(function($) {
        $(document).on('change', '.estimate-purchase-select-field', function() {
            var selectField = $(this);
            $('div.woocommerce').block({ message: null, overlayCSS: { background: '#fff', opacity: 0.6 } });
            $.ajax({
                type: 'POST',
                url: '<?php echo esc_url(admin_url('admin-ajax.php')); ?>',
                data: {
                    action: 'newtide_update_schedule_v13',
                    security: '<?php echo $nonce; ?>',
                    cart_item_key: selectField.data('item-key'),
                    schedule_value: selectField.val()
                },
                success: function(response) {
                    console.log('AJAX Response:', response);
                    $(document.body).trigger('wc_update_cart');
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error:', error);
                    $('div.woocommerce').unblock();
                }
            });
        });
        $(document.body).on('updated_wc_div', function(){
            $('div.woocommerce').unblock();
        });
    });
    </script>
    <?php
}

function newtide_ajax_update_schedule_handler_v13() {
    check_ajax_referer('newtide-schedule-nonce-v13', 'security');
    
    if (!isset($_POST['cart_item_key'])) {
        newtide_debug_log_v13('AJAX Error: Missing cart_item_key');
        wp_send_json_error('Missing key.');
    }
    
    $cart_item_key = sanitize_text_field($_POST['cart_item_key']);
    $schedule_value = isset($_POST['schedule_value']) ? sanitize_text_field($_POST['schedule_value']) : '';
    
    newtide_debug_log_v13('AJAX Handler 啟動', array(
        'cart_item_key' => $cart_item_key,
        'schedule_value' => $schedule_value
    ));
    
    $cart = WC()->cart->get_cart();
    
    if (isset($cart[$cart_item_key])) {
        $cart[$cart_item_key][NEWTIDE_META_KEY_V13] = $schedule_value;
        WC()->cart->set_cart_contents($cart);
        WC()->cart->set_session();
        
        newtide_debug_log_v13('資料已寫入購物車 Session', array(
            'cart_item_key' => $cart_item_key,
            'schedule_value' => $schedule_value,
            'product_name' => $cart[$cart_item_key]['data']->get_name()
        ));
        
        wp_send_json_success('Schedule updated.');
    } else {
        newtide_debug_log_v13('AJAX Error: Cart item not found', array('cart_item_key' => $cart_item_key));
        wp_send_json_error('Cart item not found.');
    }
}

function newtide_get_schedule_from_session_v13($cart_item, $values) {
    if (isset($values[NEWTIDE_META_KEY_V13])) {
        $cart_item[NEWTIDE_META_KEY_V13] = $values[NEWTIDE_META_KEY_V13];
        newtide_debug_log_v13('從 Session 載入資料', array(
            'product_id' => $cart_item['product_id'],
            'value' => $values[NEWTIDE_META_KEY_V13]
        ));
    }
    return $cart_item;
}

// --- 改進的儲存邏輯 ---
function newtide_add_custom_data_to_order_item_v13( $item, $cart_item_key, $values, $order ) {
    newtide_debug_log_v13('Hook: woocommerce_checkout_create_order_line_item 觸發', array(
        'cart_item_key' => $cart_item_key,
        'product_id' => $values['product_id'],
        'product_name' => $item->get_name(),
        'has_schedule' => isset($values[NEWTIDE_META_KEY_V13]),
        'schedule_value' => isset($values[NEWTIDE_META_KEY_V13]) ? $values[NEWTIDE_META_KEY_V13] : 'NOT SET'
    ));
    
    if ( isset( $values[NEWTIDE_META_KEY_V13] ) && ! empty( $values[NEWTIDE_META_KEY_V13] ) ) {
        $schedule_value = $values[NEWTIDE_META_KEY_V13];
        
        // 使用 WooCommerce 的標準方法儲存 meta data
        $item->add_meta_data( NEWTIDE_LABEL_V13, $schedule_value, true );
        
        newtide_debug_log_v13('訂單項目資料已儲存 (方法1)', array(
            'order_id' => $order->get_id(),
            'item_id' => $item->get_id(),
            'meta_key' => NEWTIDE_LABEL_V13,
            'meta_value' => $schedule_value
        ));
        
        // 立即儲存以確保資料寫入
        $item->save();
        
        // 驗證儲存
        $saved_value = $item->get_meta(NEWTIDE_LABEL_V13);
        newtide_debug_log_v13('驗證儲存結果 (方法1)', array(
            'saved_value' => $saved_value,
            'save_success' => ($saved_value === $schedule_value)
        ));
    } else {
        newtide_debug_log_v13('略過儲存 - 沒有排程資料', array(
            'product_name' => $item->get_name()
        ));
    }
}

// --- 備用儲存方法 ---
function newtide_save_order_item_meta_v13( $item_id, $item, $order_id ) {
    newtide_debug_log_v13('Hook: woocommerce_new_order_item 觸發', array(
        'item_id' => $item_id,
        'order_id' => $order_id,
        'item_type' => $item->get_type()
    ));
    
    // 只處理產品項目
    if ( $item->get_type() !== 'line_item' ) {
        return;
    }
    
    // 檢查是否已經有資料
    $existing_value = $item->get_meta(NEWTIDE_LABEL_V13);
    if ( $existing_value ) {
        newtide_debug_log_v13('訂單項目已有資料，跳過', array(
            'existing_value' => $existing_value
        ));
        return;
    }
    
    // 嘗試從購物車 session 取得資料
    $cart = WC()->cart->get_cart();
    foreach ( $cart as $cart_item_key => $cart_item ) {
        if ( $cart_item['product_id'] == $item->get_product_id() ) {
            if ( isset( $cart_item[NEWTIDE_META_KEY_V13] ) && ! empty( $cart_item[NEWTIDE_META_KEY_V13] ) ) {
                $schedule_value = $cart_item[NEWTIDE_META_KEY_V13];
                
                // 使用 wc_add_order_item_meta 儲存
                wc_add_order_item_meta( $item_id, NEWTIDE_LABEL_V13, $schedule_value, true );
                
                newtide_debug_log_v13('訂單項目資料已儲存 (方法2)', array(
                    'item_id' => $item_id,
                    'product_id' => $item->get_product_id(),
                    'meta_value' => $schedule_value
                ));
                
                break;
            }
        }
    }
}

// --- 隱藏不必要的 meta 顯示 ---
function newtide_hide_order_item_meta_v13( $hidden_meta ) {
    $hidden_meta[] = NEWTIDE_META_KEY_V13;
    return $hidden_meta;
}

// --- Legacy 儲存方法 (相容舊版) ---
function newtide_legacy_save_order_item_meta_v13( $item_id, $values, $cart_item_key ) {
    newtide_debug_log_v13('Hook: woocommerce_add_order_item_meta 觸發 (Legacy)', array(
        'item_id' => $item_id,
        'cart_item_key' => $cart_item_key,
        'has_schedule' => isset($values[NEWTIDE_META_KEY_V13])
    ));
    
    if ( isset( $values[NEWTIDE_META_KEY_V13] ) && ! empty( $values[NEWTIDE_META_KEY_V13] ) ) {
        $schedule_value = $values[NEWTIDE_META_KEY_V13];
        
        // 使用舊版方法儲存
        wc_add_order_item_meta( $item_id, NEWTIDE_LABEL_V13, $schedule_value, true );
        
        newtide_debug_log_v13('訂單項目資料已儲存 (Legacy 方法)', array(
            'item_id' => $item_id,
            'meta_value' => $schedule_value
        ));
    }
}

// --- 後台顯示函式（改進版）---
function newtide_display_admin_order_item_field_v13($item_id, $item) {
    if (!is_a($item, 'WC_Order_Item_Product')) return;
    
    $value = $item->get_meta(NEWTIDE_LABEL_V13);
    
    newtide_debug_log_v13('後台顯示訂單項目', array(
        'item_id' => $item_id,
        'product_name' => $item->get_name(),
        'current_value' => $value,
        'meta_exists' => !empty($value)
    ));
    
    ?>
    <div style="margin-top:10px; padding:10px; border:1px solid #ddd; background:#f9f9f9;">
        <label for="newtide_schedule_<?php echo $item_id; ?>" style="display:block; font-weight:bold; margin-bottom: 5px;">
            <?php echo esc_html(NEWTIDE_LABEL_V13); ?>:
        </label>
        <?php if ($value): ?>
            <div style="margin-bottom: 5px; color: #2271b1;">
                <strong>目前值：</strong> <?php echo esc_html($value); ?>
            </div>
        <?php else: ?>
            <div style="margin-bottom: 5px; color: #d63638;">
                <em>（無資料）</em> - 可在下方手動輸入
            </div>
        <?php endif; ?>
        <select id="newtide_schedule_<?php echo $item_id; ?>" 
                name="newtide_schedule[<?php echo $item_id; ?>]" 
                style="width:100%;">
            <option value="">-- 請選擇 --</option>
            <optgroup label="Short Term">
                <option value="< 1 month" <?php selected($value, '< 1 month'); ?>>< 1 month</option>
                <option value="1-3 months" <?php selected($value, '1-3 months'); ?>>1-3 months</option>
            </optgroup>
            <optgroup label="Mid Term">
                <option value="3-6 months" <?php selected($value, '3-6 months'); ?>>3-6 months</option>
                <option value="6-12 months" <?php selected($value, '6-12 months'); ?>>6-12 months</option>
            </optgroup>
            <optgroup label="Long Term">
                <option value="> 1 year" <?php selected($value, '> 1 year'); ?>>> 1 year</option>
            </optgroup>
        </select>
        <p style="font-size: 11px; color: #666; margin: 5px 0 0 0;">
            提示：儲存訂單後，此欄位將會更新
        </p>
    </div>
    <?php
}

// --- 調試顯示所有 meta ---
function newtide_debug_display_all_meta_v13($item_id, $item) {
    if (!NEWTIDE_DEBUG_V13 || !is_a($item, 'WC_Order_Item_Product')) return;
    
    $all_meta = $item->get_meta_data();
    if (!empty($all_meta)) {
        echo '<div style="margin-top:10px; padding:10px; background:#f0f0f0; font-size:11px; font-family:monospace;">';
        echo '<strong>DEBUG - All Meta Data:</strong><br>';
        foreach ($all_meta as $meta) {
            echo sprintf('[%s] => %s<br>', 
                esc_html($meta->key), 
                esc_html(is_array($meta->value) ? json_encode($meta->value) : $meta->value)
            );
        }
        echo '</div>';
    }
}

// --- 儲存後台修改 ---
function newtide_save_admin_order_item_field_v13($order_id, $items) {
    if (isset($_POST['newtide_schedule']) && is_array($_POST['newtide_schedule'])) {
        newtide_debug_log_v13('後台儲存訂單項目', array(
            'order_id' => $order_id,
            'posted_data' => $_POST['newtide_schedule']
        ));
        
        foreach ($_POST['newtide_schedule'] as $item_id => $schedule) {
            $sanitized_value = sanitize_text_field($schedule);
            if ($sanitized_value !== '') {
                wc_update_order_item_meta($item_id, NEWTIDE_LABEL_V13, $sanitized_value);
                newtide_debug_log_v13('更新項目 meta', array(
                    'item_id' => $item_id,
                    'new_value' => $sanitized_value
                ));
            } else {
                wc_delete_order_item_meta($item_id, NEWTIDE_LABEL_V13);
                newtide_debug_log_v13('刪除項目 meta', array('item_id' => $item_id));
            }
        }
    }
}

// --- 前端訂單詳情顯示 ---
function newtide_display_schedule_in_order_details_v13($item_id, $item, $order, $plain_text) {
    $schedule = $item->get_meta(NEWTIDE_LABEL_V13);
    
    newtide_debug_log_v13('前端顯示訂單詳情', array(
        'item_id' => $item_id,
        'schedule' => $schedule,
        'is_plain_text' => $plain_text
    ));
    
    if ($schedule && is_scalar($schedule)) {
        $label = '<strong>' . esc_html(NEWTIDE_LABEL_V13) . ':</strong> ';
        if ($plain_text) {
            echo "\n" . strip_tags($label) . ' ' . esc_html($schedule);
        } else {
            echo '<div style="margin-top: 5px; color: #2271b1;">' . $label . esc_html($schedule) . '</div>';
        }
    }
}

// --- 診斷功能 ---
function newtide_ajax_run_diagnostic_v13() {
    check_ajax_referer('newtide-diagnostic-nonce', 'security');
    
    if (!current_user_can('manage_options')) {
        wp_send_json_error('Permission denied');
    }
    
    $diagnostic = array();
    
    // 檢查 WooCommerce 版本
    $diagnostic[] = '<h4>WooCommerce 資訊</h4>';
    $diagnostic[] = 'WooCommerce 版本: ' . WC_VERSION;
    
    // 檢查 Hooks
    $diagnostic[] = '<h4>Hook 檢查</h4>';
    $hooks_to_check = array(
        'woocommerce_checkout_create_order_line_item',
        'woocommerce_new_order_item',
        'woocommerce_add_order_item_meta'
    );
    
    foreach ($hooks_to_check as $hook) {
        $has_actions = has_action($hook);
        $diagnostic[] = sprintf('%s: %s', $hook, $has_actions ? '✓ 已註冊' : '✗ 未註冊');
    }
    
    // 檢查購物車
    $diagnostic[] = '<h4>購物車狀態</h4>';
    $cart = WC()->cart->get_cart();
    if (empty($cart)) {
        $diagnostic[] = '購物車是空的';
    } else {
        foreach ($cart as $key => $item) {
            $schedule = isset($item[NEWTIDE_META_KEY_V13]) ? $item[NEWTIDE_META_KEY_V13] : '無';
            $diagnostic[] = sprintf('商品: %s | Schedule: %s', 
                $item['data']->get_name(), 
                $schedule
            );
        }
    }
    
    // 檢查最近的訂單
    $diagnostic[] = '<h4>最近訂單檢查</h4>';
    $recent_orders = wc_get_orders(array(
        'limit' => 3,
        'orderby' => 'date',
        'order' => 'DESC'
    ));
    
    foreach ($recent_orders as $order) {
        $diagnostic[] = sprintf('<strong>訂單 #%d</strong>', $order->get_id());
        foreach ($order->get_items() as $item) {
            $schedule = $item->get_meta(NEWTIDE_LABEL_V13);
            $diagnostic[] = sprintf('- %s: %s', 
                $item->get_name(), 
                $schedule ? $schedule : '無資料'
            );
        }
    }
    
    $html = '<div>' . implode('<br>', $diagnostic) . '</div>';
    
    newtide_debug_log_v13('執行診斷', array('timestamp' => current_time('mysql')));
    
    wp_send_json_success($html);
}



// --- Shortcode for Custom Cart ---
add_shortcode('newtide_custom_cart', 'newtide_custom_cart_shortcode_v13');

// --- 自訂購物車 Shortcode 函式 ---
function newtide_custom_cart_shortcode_v13($atts) {
    // 確保 WooCommerce 已載入
    if (!class_exists('WooCommerce')) {
        return '<p>WooCommerce 未啟用。</p>';
    }
    
    // 開始輸出緩衝
    ob_start();
    
    // 獲取購物車內容
    $cart = WC()->cart->get_cart();
    
    if (empty($cart)) {
        ?>
        <div class="newtide-custom-cart empty-cart">
            <p>您的詢價單目前是空的。</p>
            <a href="<?php echo get_permalink(wc_get_page_id('shop')); ?>" class="button">繼續選購</a>
        </div>
        <?php
        return ob_get_clean();
    }
    
    // 產生 nonce
    $nonce = wp_create_nonce('newtide-custom-cart-nonce');
    ?>
    
    <div class="newtide-custom-cart">
        <form class="newtide-cart-form" method="post">
            <?php wp_nonce_field('newtide-custom-checkout', 'newtide_checkout_nonce'); ?>
            
            <table class="newtide-cart-table">
                <thead>
                    <tr>
                        <th class="product-thumbnail">View Picture</th>
                        <th class="product-name">Selected Items</th>
                        <th class="product-quantity">Estimate Purchasing Quantity</th>
                        <th class="product-schedule">Estimate Purchasing Schedule</th>
                        <th class="product-remove">Delete</th>
                    </tr>
                </thead>
                <tbody>
                    <?php
                    foreach ($cart as $cart_item_key => $cart_item) {
                        $_product = apply_filters('woocommerce_cart_item_product', $cart_item['data'], $cart_item, $cart_item_key);
                        $product_id = apply_filters('woocommerce_cart_item_product_id', $cart_item['product_id'], $cart_item, $cart_item_key);
                        
                        if ($_product && $_product->exists() && $cart_item['quantity'] > 0 && apply_filters('woocommerce_cart_item_visible', true, $cart_item, $cart_item_key)) {
                            $product_permalink = apply_filters('woocommerce_cart_item_permalink', $_product->is_visible() ? $_product->get_permalink($cart_item) : '', $cart_item, $cart_item_key);
                            $product_name = apply_filters('woocommerce_cart_item_name', $_product->get_name(), $cart_item, $cart_item_key);
                            $product_thumbnail = apply_filters('woocommerce_cart_item_thumbnail', $_product->get_image(), $cart_item, $cart_item_key);
                            $product_price = apply_filters('woocommerce_cart_item_price', WC()->cart->get_product_price($_product), $cart_item, $cart_item_key);
                            
                            // 獲取當前的 schedule 值
                            $schedule_value = isset($cart_item[NEWTIDE_META_KEY_V13]) ? $cart_item[NEWTIDE_META_KEY_V13] : '';
                            ?>
                            <tr class="cart-item" data-cart-item-key="<?php echo esc_attr($cart_item_key); ?>">
                                <!-- View Picture -->
                                <td class="product-thumbnail">
                                    <?php
                                    if (!$product_permalink) {
                                        echo $product_thumbnail;
                                    } else {
                                        printf('<a href="%s">%s</a>', esc_url($product_permalink), $product_thumbnail);
                                    }
                                    ?>
                                </td>
                                
                                <!-- Selected Items -->
                                <td class="product-name">
                                    <?php
                                    if (!$product_permalink) {
                                        echo wp_kses_post($product_name);
                                    } else {
                                        echo wp_kses_post(sprintf('<a href="%s">%s</a>', esc_url($product_permalink), $product_name));
                                    }
                                    
                                    // 顯示產品屬性
                                    echo wc_get_formatted_cart_item_data($cart_item);
                                    ?>
                                </td>
                                
                                <!-- Estimate Purchasing Quantity -->
                                <td class="product-quantity">
                                    <input type="number" 
                                           class="quantity-input" 
                                           name="cart[<?php echo $cart_item_key; ?>][qty]" 
                                           value="<?php echo $cart_item['quantity']; ?>" 
                                           min="0" 
                                           step="1"
                                           data-cart-item-key="<?php echo esc_attr($cart_item_key); ?>">
                                </td>
                                
                                <!-- Estimate Purchasing Schedule -->
                                <td class="product-schedule">
                                    <select class="schedule-select" 
                                            name="cart[<?php echo $cart_item_key; ?>][schedule]"
                                            data-cart-item-key="<?php echo esc_attr($cart_item_key); ?>">
                                        <option value="">-- 請選擇 --</option>
                                        <optgroup label="Short Term">
                                            <option value="< 1 month" <?php selected($schedule_value, '< 1 month'); ?>>< 1 month</option>
                                            <option value="1-3 months" <?php selected($schedule_value, '1-3 months'); ?>>1-3 months</option>
                                        </optgroup>
                                        <optgroup label="Mid Term">
                                            <option value="3-6 months" <?php selected($schedule_value, '3-6 months'); ?>>3-6 months</option>
                                            <option value="6-12 months" <?php selected($schedule_value, '6-12 months'); ?>>6-12 months</option>
                                        </optgroup>
                                        <optgroup label="Long Term">
                                            <option value="> 1 year" <?php selected($schedule_value, '> 1 year'); ?>>> 1 year</option>
                                        </optgroup>
                                    </select>
                                </td>
                                
                                <!-- Delete -->
                                <td class="product-remove">
                                    <a href="#" class="remove-item" data-cart-item-key="<?php echo esc_attr($cart_item_key); ?>" title="刪除此項目">
                                        <span class="dashicons dashicons-trash"></span>
                                    </a>
                                </td>
                            </tr>
                            <?php
                        }
                    }
                    ?>
                </tbody>
            </table>
            
            <!-- 客戶資訊表單 -->
            <div class="customer-info-section">
                <div class="form-section-intro">
                    <span>To provide you the best service, Please fill out the form below.</span>
                </div>

                <h3>Information of Contact Person :</h3>

                <div class="form-row">
                    <div class="form-col">
                        <label for="billing_first_name">Name <span class="required">*</span></label>
                        <input type="text" id="billing_first_name" name="billing_first_name" placeholder="Name*" required>
                    </div>
                    <div class="form-col">
                        <label for="billing_last_name">Last name <span class="required">*</span></label>
                        <input type="text" id="billing_last_name" name="billing_last_name" placeholder="Last name*" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-col">
                        <label for="contact_gender">Gender</label>
                        <select id="contact_gender" name="contact_gender">
                            <option value="Gender">Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                    <div class="form-col">
                        <label for="billing_email">Email <span class="required">*</span></label>
                        <input type="email" id="billing_email" name="billing_email" placeholder="E-mail*" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-col">
                        <label for="contact_department">Department <span class="required">*</span></label>
                        <input type="text" id="contact_department" name="contact_department" placeholder="Department*" required>
                    </div>
                    <div class="form-col">
                        <label for="contact_job_title">Job Title <span class="required">*</span></label>
                        <input type="text" id="contact_job_title" name="contact_job_title" placeholder="Job Title*" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-col full-width">
                        <label class="checkbox-label">
                            <input type="checkbox" name="contact_subscribe" value="yes">
                            Please mail me detail information of products, services and news of events.
                        </label>
                    </div>
                </div>

                <h3>Company Information :</h3>

                <div class="form-row">
                    <div class="form-col">
                        <label for="billing_company">Company <span class="required">*</span></label>
                        <input type="text" id="billing_company" name="billing_company" placeholder="Company*" required>
                    </div>
                    <div class="form-col">
                        <label for="company_url">URL</label>
                        <input type="url" id="company_url" name="company_url" placeholder="URL">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-col">
                        <label for="company_industry">Industry</label>
                        <select id="company_industry" name="company_industry">
                            <option value="Industry">Industry</option>
                            <option value="Audio">Audio</option>
                            <option value="Video">Video</option>
                            <option value="Communication">Communication</option>
                            <option value="Computer">Computer</option>
                            <option value="Medical">Medical</option>
                            <option value="Electronic">Electronic</option>
                            <option value="Transportation">Transportation</option>
                            <option value="Instrument">Instrument</option>
                            <option value="Manufacturing">Manufacturing</option>
                            <option value="Retail">Retail</option>
                            <option value="Healthcare">Healthcare</option>
                            <option value="Automotive">Automotive</option>
                            <option value="Aerospace">Aerospace</option>
                            <option value="Energy">Energy</option>
                            <option value="Construction">Construction</option>
                            <option value="Education">Education</option>
                            <option value="Finance">Finance</option>
                            <option value="Hospitality">Hospitality</option>
                            <option value="Food and Beverage">Food and Beverage</option>
                            <option value="Pharmaceutical">Pharmaceutical</option>
                        </select>
                    </div>
                    <div class="form-col">
                        <label for="company_main_product">Main Product</label>
                        <input type="text" id="company_main_product" name="company_main_product" placeholder="Main Product">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-col full-width">
                        <label for="billing_address">Address</label>
                        <input type="text" id="billing_address" name="billing_address" placeholder="Address">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-col">
                        <label for="billing_state">State</label>
                        <input type="text" id="billing_state" name="billing_state" placeholder="State">
                    </div>
                    <div class="form-col">
                        <label for="billing_postcode">Postal Code</label>
                        <input type="text" id="billing_postcode" name="billing_postcode" placeholder="Postal Code">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-col full-width">
                        <label for="billing_country">Country <span class="required">*</span></label>
                        <select id="billing_country" name="billing_country" required>
                            <option value="Taiwan">Taiwan</option>
                            <option value="United States">United States</option>
                            <option value="Canada">Canada</option>
                            <option value="United Kingdom">United Kingdom</option>
                            <option value="Australia">Australia</option>
                            <option value="Germany">Germany</option>
                            <option value="France">France</option>
                            <option value="Japan">Japan</option>
                            <option value="China">China</option>
                            <option value="India">India</option>
                            </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-col">
                        <label for="billing_phone">Telephone <span class="required">*</span></label>
                        <input type="tel" id="billing_phone" name="billing_phone" placeholder="Telephone*" required>
                    </div>
                    <div class="form-col">
                        <label for="company_fax">Fax <span class="required">*</span></label>
                        <input type="tel" id="company_fax" name="company_fax" placeholder="Fax*" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-col full-width">
                        <label>Business Type</label>
                        <div class="checkbox-group checkbox-group-inline">
                            <label><input type="checkbox" name="business_type[]" value="Importer"> Importer</label>
                            <label><input type="checkbox" name="business_type[]" value="Distributor"> Distributor</label>
                            <label><input type="checkbox" name="business_type[]" value="Exporter"> Exporter</label>
                            <label><input type="checkbox" name="business_type[]" value="Trader"> Trader</label>
                            <label><input type="checkbox" name="business_type[]" value="Wholesaler"> Wholesaler</label>
                            <label><input type="checkbox" name="business_type[]" value="Retailer"> Retailer</label>
                            <label><input type="checkbox" name="business_type[]" value="Agent"> Agent</label>
                            <label><input type="checkbox" name="business_type[]" value="Manufacturer"> Manufacturer</label>
                            <label><input type="checkbox" name="business_type[]" value="Trading Company"> Trading Company</label>
                            <label><input type="checkbox" name="business_type[]" value="Others"> Others</label>
                        </div>
                    </div>
                </div>

                <h3>Others :</h3>
                
                <div class="form-row">
                    <div class="form-col full-width">
                        <label style="font-weight: bold;">Request of detail information</label>
                         <div class="checkbox-group checkbox-group-block">
                            <label><input type="checkbox" name="request_details[]" value="FOB prices (for minimum order quantity)"> FOB prices (for minimum order quantity)</label>
                            <label><input type="checkbox" name="request_details[]" value="Minimum order quantity"> Minimum order quantity</label>
                            <label><input type="checkbox" name="request_details[]" value="Lead Time"> Lead Time</label>
                            <label><input type="checkbox" name="request_details[]" value="Shipping Date"> Shipping Date</label>
                            <label><input type="checkbox" name="request_details[]" value="Expected Delivery Date"> Expected Delivery Date</label>
                            <label><input type="checkbox" name="request_details[]" value="Sample availability/Cost"> Sample availability/Cost</label>
                            <label><input type="checkbox" name="request_details[]" value="Company Brochure"> Company Brochure</label>
                            <label><input type="checkbox" name="request_details[]" value="International standards met"> International standards met</label>
                            <label><input type="checkbox" name="request_details[]" value="Others"> Others</label>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-col full-width">
                        <label for="order_comments">Special Comment</label>
                        <textarea id="order_comments" name="order_comments" rows="4" placeholder="Special Comment"></textarea>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-col full-width privacy-policy-notice">
                        <span>By submitting your contact information, you acknowledge that you consent to our processing data in accordance with the Privacy and Cookie Policy.</span>
                    </div>
                </div>

            </div>
    <!-- CSS 樣式 -->
<style>
    /* --- Start of Original Plugin Styles --- */
    .newtide-custom-cart {
        max-width: 1200px; 
        margin: 0 auto; 
        padding: 20px; 
    }
    
    .newtide-cart-table {
        width: 100%; 
        border-collapse: collapse; 
        margin-bottom: 30px; 
        background: #fff; 
        box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
    }
    
    .newtide-cart-table th,
    .newtide-cart-table td {
        padding: 15px; 
        text-align: left; 
        border-bottom: 1px solid #e5e5e5; 
    }
    
    .newtide-cart-table th {
        background: #f8f9fa; 
        font-weight: 600; 
        color: #333; 
    }
    
    .newtide-cart-table tbody tr:hover {
        background: #f9f9f9; 
    }
    
    .product-thumbnail img {
        width: 80px; 
        height: auto; 
        border: 1px solid #e5e5e5; 
    }
    
    .product-name {
        min-width: 200px; 
    }
    
    .product-name a {
        text-decoration: none; 
        color: #333; 
        font-weight: 500; 
    }
    
    .product-name a:hover {
        color: #0073aa; 
    }
    
    .quantity-input {
        width: 80px; 
        padding: 8px; 
        border: 1px solid #ddd; 
        border-radius: 4px; 
        text-align: center; 
    }
    
    .schedule-select {
        width: 150px; 
        padding: 8px; 
        border: 1px solid #ddd; 
        border-radius: 4px; 
    }
    
    .remove-item {
        color: #dc3545; 
        text-decoration: none; 
        font-size: 20px; 
    }
    
    .remove-item:hover {
        color: #c82333; 
    }

    .cart-actions {
        text-align: right; 
        margin-top: 20px; 
    }
    
    .button {
        padding: 12px 24px; 
        border: none; 
        border-radius: 4px; 
        font-size: 16px; 
        cursor: pointer; 
        text-decoration: none; 
        display: inline-block; 
        margin-left: 10px; 
        transition: background-color 0.3s; 
    }
    
    .button:first-child {
        margin-left: 0; 
    }
    
    .button.update-cart {
        background: #6c757d; 
        color: white; 
    }
    
    .button.update-cart:hover {
        background: #5a6268; 
    }
    
    .button-primary {
        background: #007cba; 
        color: white; 
    }
    
    .button-primary:hover {
        background: #005a87; 
    }
    
    .empty-cart {
        text-align: center; 
        padding: 50px; 
        background: #fff; 
        box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
    }
    
    .empty-cart p {
        font-size: 18px; 
        margin-bottom: 20px; 
        color: #666; 
    }
    
    @media (max-width: 768px) {
        .newtide-cart-table {
            font-size: 14px; 
        }
        
        .newtide-cart-table th,
        .newtide-cart-table td {
            padding: 10px 5px; 
        }
        
        .product-thumbnail img {
            width: 60px; 
        }
        
        .quantity-input,
        .schedule-select {
            width: 100%; 
        }
        
        .form-row {
            flex-direction: column; 
        }
        
        .cart-actions {
            text-align: center; 
        }
        
        .button {
            display: block; 
            width: 100%; 
            margin: 10px 0; 
        }
    }
    /* --- End of Original Plugin Styles --- */


    /* --- Newtide Inquiry Form Styles (Final Version with Alignment Fix) --- */

    /* 表單區塊的整體間距和標題 */
    .newtide-custom-cart .customer-info-section {
        background: #fff; 
        padding: 30px; 
        margin-bottom: 20px; 
        box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
    }

    /* 模擬 JSON 中的 H3 樣式 */
    .newtide-custom-cart .customer-info-section h3 {
        margin-top: 20px;
        margin-bottom: 25px; 
        background-color: #f5f5f5;
        padding: 15px;
        color: #23262F;
        font-family: "Noto Sans TC", sans-serif;
        font-size: 20px;
        font-style: normal;
        font-weight: 500; 
        line-height: 24px;
    }
    .newtide-custom-cart .customer-info-section h3:first-of-type {
        margin-top: 0; 
    }

    /* 欄位標籤 Label */
    .newtide-custom-cart .form-col label {
        display: block; 
        margin-bottom: 5px; 
        font-weight: 400;
        font-family: "Noto Sans TC", sans-serif;
        font-size: 16px;
        color: #8F8F8F;
    }

    /* 針對 "Request of detail information" 的粗體標籤 */
    .newtide-custom-cart .form-col label[style*="font-weight: bold"] {
        color: #8F8F8F;
        font-weight: bold; 
    }

    /* 所有文字輸入框、下拉選單、文字區域的通用樣式 */
    .newtide-custom-cart .form-col input[type="text"],
    .newtide-custom-cart .form-col input[type="email"],
    .newtide-custom-cart .form-col input[type="tel"],
    .newtide-custom-cart .form-col input[type="url"],
    .newtide-custom-cart .form-col select,
    .newtide-custom-cart .form-col textarea {
        width: 100%; 
        padding: 12px 15px;
        border: 1px solid #E6E8EC;
        border-radius: 8px;
        font-size: 14px; 
        color: #69727D;
        background-color: #fff;
        transition: border-color 0.3s;
    }

    .newtide-custom-cart .form-col input:focus,
    .newtide-custom-cart .form-col select:focus,
    .newtide-custom-cart .form-col textarea:focus {
        border-color: #69727d !important;
        outline: none;
    }

    /* --- Checkbox 樣式修正 v2 --- */

    /* Checkbox Label 通用樣式 */
    .newtide-custom-cart .checkbox-group label {
        font-weight: normal;
        cursor: pointer;
        color: #8F8F8F;
    }

    /* 內行樣式 (Business Type) - 垂直對齊修正 */
    .newtide-custom-cart .checkbox-group-inline {
        display: flex;
        flex-wrap: wrap;
        gap: 10px 20px;
    }
    .newtide-custom-cart .checkbox-group-inline label {
        white-space: nowrap; /* 防止標籤文字換行 */
    }
    .newtide-custom-cart .checkbox-group-inline input[type="checkbox"] {
        margin-right: 8px;
        vertical-align: middle; /* 關鍵：讓勾選框與文字垂直置中對齊 */
    }

    /* 區塊樣式 (Request of detail information) */
    .newtide-custom-cart .checkbox-group-block label {
        display: block;
        margin-bottom: 12px;
    }
    .newtide-custom-cart .checkbox-group-block label:last-child {
        margin-bottom: 0;
    }
    .newtide-custom-cart .checkbox-group-block input[type="checkbox"] {
        margin-right: 8px;
        vertical-align: middle;
    }
    /* --- Checkbox 樣式修正結束 --- */


    /* 隱私權政策提示文字 */
    .newtide-custom-cart .privacy-policy-notice span {
        font-size: 13px;
        color: #868686;
    }
    
    .newtide-custom-cart .form-row {
        display: flex; 
        gap: 20px; 
        margin-bottom: 25px;
    }

    .newtide-custom-cart .form-col {
        flex: 1; 
    }

    .newtide-custom-cart .form-col.full-width {
        flex: 1 0 100%; 
    }

</style>
    
    <!-- JavaScript -->
    <script type="text/javascript">
    jQuery(function($) {
        // 更新數量
        $(document).on('change', '.quantity-input', function() {
            var $input = $(this);
            var cartItemKey = $input.data('cart-item-key');
            var quantity = $input.val();
            
            if (quantity == 0) {
                if (confirm('確定要從詢價單中移除此項目嗎？')) {
                    removeItem(cartItemKey);
                } else {
                    $input.val(1);
                }
            }
        });
        
        // 更新 Schedule
        $(document).on('change', '.schedule-select', function() {
            var $select = $(this);
            var cartItemKey = $select.data('cart-item-key');
            var scheduleValue = $select.val();
            
            $.ajax({
                type: 'POST',
                url: '<?php echo admin_url('admin-ajax.php'); ?>',
                data: {
                    action: 'newtide_update_schedule_v13',
                    security: '<?php echo wp_create_nonce('newtide-schedule-nonce-v13'); ?>',
                    cart_item_key: cartItemKey,
                    schedule_value: scheduleValue
                },
                success: function(response) {
                    console.log('Schedule updated:', response);
                }
            });
        });
        
        // 刪除項目
        $(document).on('click', '.remove-item', function(e) {
            e.preventDefault();
            var cartItemKey = $(this).data('cart-item-key');
            
            if (confirm('確定要從詢價單中移除此項目嗎？')) {
                removeItem(cartItemKey);
            }
        });
        
        // 刪除項目函式
        function removeItem(cartItemKey) {
            $.ajax({
                type: 'POST',
                url: '<?php echo admin_url('admin-ajax.php'); ?>',
                data: {
                    action: 'newtide_remove_cart_item',
                    security: '<?php echo $nonce; ?>',
                    cart_item_key: cartItemKey
                },
                success: function(response) {
                    if (response.success) {
                        location.reload();
                    }
                }
            });
        }
        
        // 更新購物車
        $('.update-cart').on('click', function() {
            var updates = [];
            
            $('.quantity-input').each(function() {
                var $input = $(this);
                updates.push({
                    key: $input.data('cart-item-key'),
                    quantity: $input.val()
                });
            });
            
            $.ajax({
                type: 'POST',
                url: '<?php echo admin_url('admin-ajax.php'); ?>',
                data: {
                    action: 'newtide_update_cart_quantities',
                    security: '<?php echo $nonce; ?>',
                    updates: updates
                },
                success: function(response) {
                    if (response.success) {
                        location.reload();
                    }
                }
            });
        });
    });
    </script>
    
    <?php
    return ob_get_clean();
}

// --- AJAX: 移除購物車項目 ---
add_action('wp_ajax_newtide_remove_cart_item', 'newtide_ajax_remove_cart_item');
add_action('wp_ajax_nopriv_newtide_remove_cart_item', 'newtide_ajax_remove_cart_item');

function newtide_ajax_remove_cart_item() {
    check_ajax_referer('newtide-custom-cart-nonce', 'security');
    
    $cart_item_key = sanitize_text_field($_POST['cart_item_key']);
    
    if (WC()->cart->remove_cart_item($cart_item_key)) {
        wp_send_json_success('Item removed');
    } else {
        wp_send_json_error('Failed to remove item');
    }
}

// --- AJAX: 更新購物車數量 ---
add_action('wp_ajax_newtide_update_cart_quantities', 'newtide_ajax_update_cart_quantities');
add_action('wp_ajax_nopriv_newtide_update_cart_quantities', 'newtide_ajax_update_cart_quantities');

function newtide_ajax_update_cart_quantities() {
    check_ajax_referer('newtide-custom-cart-nonce', 'security');
    
    $updates = $_POST['updates'];
    
    foreach ($updates as $update) {
        $cart_item_key = sanitize_text_field($update['key']);
        $quantity = intval($update['quantity']);
        
        if ($quantity > 0) {
            WC()->cart->set_quantity($cart_item_key, $quantity);
        } else {
            WC()->cart->remove_cart_item($cart_item_key);
        }
    }
    
    wp_send_json_success('Cart updated');
}

// --- 處理詢價單提交 ---
add_action('init', 'newtide_handle_custom_checkout');

function newtide_handle_custom_checkout() {
    if (!isset($_POST['newtide_checkout_nonce']) || !wp_verify_nonce($_POST['newtide_checkout_nonce'], 'newtide-custom-checkout')) {
        return;
    }
    
    // 確保購物車不是空的
    if (WC()->cart->is_empty()) {
        wc_add_notice('您的詢價單是空的。', 'error');
        return;
    }
    
    // 收集客戶資料
    $billing_data = array(
        'first_name' => sanitize_text_field($_POST['billing_first_name']),
        'company' => sanitize_text_field($_POST['billing_company']),
        'email' => sanitize_email($_POST['billing_email']),
        'phone' => sanitize_text_field($_POST['billing_phone']),
    );
    
    // 驗證必填欄位
    if (empty($billing_data['first_name']) || empty($billing_data['email']) || empty($billing_data['phone'])) {
        wc_add_notice('請填寫所有必填欄位。', 'error');
        return;
    }
    
    // 建立訂單
    $order = wc_create_order();
    
    // 設定客戶資料
    $order->set_billing_first_name($billing_data['first_name']);
    $order->set_billing_company($billing_data['company']);
    $order->set_billing_email($billing_data['email']);
    $order->set_billing_phone($billing_data['phone']);
    
    // 添加訂單備註
    if (!empty($_POST['order_comments'])) {
        $order->set_customer_note(sanitize_textarea_field($_POST['order_comments']));
    }
    
    // 將購物車項目加入訂單
    foreach (WC()->cart->get_cart() as $cart_item_key => $cart_item) {
        $product = $cart_item['data'];
        $quantity = $cart_item['quantity'];
        
        // 加入訂單項目
        $item_id = $order->add_product($product, $quantity, array(
            'variation' => $cart_item['variation'],
            'totals' => array(
                'subtotal' => 0,
                'subtotal_tax' => 0,
                'total' => 0,
                'tax' => 0,
                'tax_data' => array()
            )
        ));
        
        // 確保 schedule 資料也被儲存
        if ($item_id && isset($cart_item[NEWTIDE_META_KEY_V13])) {
            wc_add_order_item_meta($item_id, NEWTIDE_LABEL_V13, $cart_item[NEWTIDE_META_KEY_V13]);
        }
    }
    
    // 設定訂單狀態為處理中（或您偏好的狀態）
    $order->set_status('processing');
    
    // 設定訂單總計為 0（因為是詢價單）
    $order->set_total(0);
    
    // 儲存訂單
    $order->save();
    
    // 清空購物車
    WC()->cart->empty_cart();
    
    // 記錄日誌
    newtide_debug_log_v13('詢價單已提交', array(
        'order_id' => $order->get_id(),
        'customer_email' => $billing_data['email']
    ));
    
    // 發送郵件通知（可選）
    // do_action('woocommerce_new_order', $order->get_id());
    
    // 重定向到感謝頁面
    $thank_you_page = add_query_arg('inquiry-received', $order->get_id(), home_url('/inquiry-thank-you/'));
    wp_redirect($thank_you_page);
    exit;
}

// --- 建立感謝頁面 Shortcode ---
add_shortcode('newtide_inquiry_thank_you', 'newtide_inquiry_thank_you_shortcode');

function newtide_inquiry_thank_you_shortcode() {
    $order_id = isset($_GET['inquiry-received']) ? intval($_GET['inquiry-received']) : 0;
    
    if (!$order_id) {
        return '<p>無效的詢價單編號。</p>';
    }
    
    $order = wc_get_order($order_id);
    
    if (!$order) {
        return '<p>找不到詢價單。</p>';
    }
    
    ob_start();
    ?>
    <div class="inquiry-thank-you">
        <h2>感謝您的詢價！</h2>
        <p>我們已收到您的詢價單，將盡快與您聯繫。</p>
        
        <div class="order-details">
            <h3>詢價單詳情</h3>
            <p><strong>詢價單編號：</strong> #<?php echo $order->get_id(); ?></p>
            <p><strong>日期：</strong> <?php echo $order->get_date_created()->date('Y-m-d H:i:s'); ?></p>
            <p><strong>聯絡人：</strong> <?php echo $order->get_billing_first_name(); ?></p>
            <p><strong>Email：</strong> <?php echo $order->get_billing_email(); ?></p>
            
            <h4>詢價項目：</h4>
            <table class="inquiry-items">
                <thead>
                    <tr>
                        <th>產品</th>
                        <th>數量</th>
                        <th>預計採購時程</th>
                    </tr>
                </thead>
                <tbody>
                    <?php
                    foreach ($order->get_items() as $item) {
                        $schedule = $item->get_meta(NEWTIDE_LABEL_V13);
                        ?>
                        <tr>
                            <td><?php echo $item->get_name(); ?></td>
                            <td><?php echo $item->get_quantity(); ?></td>
                            <td><?php echo $schedule ? $schedule : '-'; ?></td>
                        </tr>
                        <?php
                    }
                    ?>
                </tbody>
            </table>
            
            <?php if ($order->get_customer_note()): ?>
                <p><strong>備註：</strong> <?php echo nl2br(esc_html($order->get_customer_note())); ?></p>
            <?php endif; ?>
        </div>
        
        <p><a href="<?php echo home_url(); ?>" class="button">返回首頁</a></p>
    </div>
    
    <style>
    .inquiry-thank-you {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .order-details {
        background: #f9f9f9;
        padding: 20px;
        border-radius: 5px;
        margin: 20px 0;
    }
    
    .inquiry-items {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
    }
    
    .inquiry-items th,
    .inquiry-items td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }
    
    .inquiry-items th {
        background: #f0f0f0;
        font-weight: bold;
    }
    </style>
    <?php
    return ob_get_clean();
}
